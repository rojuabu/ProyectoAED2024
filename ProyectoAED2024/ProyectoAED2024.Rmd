---
title: Evolución y comparativa del precio de la vivienda y el salario medio
author:
  - name: Rodrigo Juanes Busolo
  - name: Noé López García
  - name: Marc Velasco Mateu
# document options
type: article
# front matter
simplesummary: |
  Con tal de poner a prueba nuestros conocimientos de análisis exploratorio de datos, analizaremos detenidamente dos datasets sobre el valor de la vivienda española y el salario medio en España.
abstract: |
  Aquí ponemos el abstract.
# back matter
acknowledgement: |
  Gracias a Marcelino Martinez Sober y a Juan Gomez Sanchis.
abbreviations:
  - short: CCAA
    long: Comunidades autónomas
bibliography: mybibfile.bib
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---
```{r carga de librerias, include=FALSE}
library(readr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(scales)
library(patchwork)
library(plotly)
library(visdat)
library(dplyr)
library(tidyr)
library(gganimate)
library(mapSpain)
library(viridis)  # Para una escala de colores visualmente atractiva
#remotes::install_github("jthomasmock/gtExtras")
library(gt)
library(gtExtras)
library(shiny)
```

```{r limpieza, include=FALSE}
rm(list = ls())
```


# Introduction

The introduction should briefly place the study in a broad context and highlight
why it is important. It should define the purpose of the work and its
significance. The current state of the research field should be reviewed
carefully and key publications cited. Please highlight controversial and
diverging hypotheses when necessary. Finally, briefly mention the main aim of
the work and highlight the principal conclusions. As far as possible, please
keep the introduction comprehensible to scientists outside your particular
field of research. Citing a journal paper [@bertrand-krajewski_distribution_1998;
@leutnant_stormwater_2016]. And now citing a book reference @gujer_systems_2008.
Some MDPI journals use Chicago and others use APA, this template should choose
the correct citation format for you once you specify the journal in the YAML
header.

# Carga de los archivos

```{r}
# Especificamos que la columna total de Salario sea de tipo character para no perder las comas al importarlo como double
Salario <- read_delim("../data/Salario.csv", delim = ";", escape_double = FALSE, col_types = cols(Total = col_character()), trim_ws = TRUE)
# Con vivienda no es necesario porque como se ve en la herramienta la columna se importa como character
Vivienda <- read_delim("../data/Vivienda.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
```

Inicialmente ejecutamos el comando str para obervar el aspecto que tienen los datos. Además, este comando nos permite visualizar el tipo de dato que contiene cada columna, lo que nos permite visualizar si alguna de ellas debería ser convertida a otro tipo de dato más acorde a la información que contiene. 
En nuestro caso, para el fichero de salario se detectó que la variable total contenía un tipo de dato str, cuando lo lógico es que esta columna sea de tipo numérico.Esto se realizó de manera intencionada al importar los datos, dado que en el INE se emplean comas para separar los decimales, algo que en R se realiza con puntos. Por ello, y para evitar conflictos; se importó como una cadena de texto y luego se realizaron las operaciones siguientes para darle el formato adecuado. Primeramente, como el punto también fue empleado para mostrar la separación de los miles, se sustituyó este elemento por vacío. Seguidamente, las comas fueron sustiuidas por puntos, para finalmente mediante el comando as.numeric convertir los datos de tipo string a numeric.
Además, dado que la variable de medias y percentiles es de tipo categórico y solo puede tomar un número finito de valores, esta fue convertida a factor. Del mismo modo, realizaremos esta conversión con la variable sexo.

```{r}
str(Salario)
# Como se puede ver el problema de la variable Total es que tiene comas y puntos,
# pero en R las comas no son interpretadas con la intención del archivo, por lo que
# pasamos a cambiar el formato, y una vez con este correcto hacer un casteo a numérico

# Primero eliminamos los puntos, que se emplean en el archivo original para hacer la
#distinción de 1000
Salario$Total<-gsub(pattern = '[.]',replacement = '',Salario$Total)
# Seguidamente cambiamos las comas por puntos para adecuarlo al formato de R
Salario$Total<-gsub(pattern = '[,]',replacement = '.',Salario$Total)
# Ahora finalmente hacemos el casteo a numeric
Salario$Total<-as.numeric(Salario$Total)
# Además la variable media y percentiles solo puede tener esos valores, por lo que la 
#transformamos en un factor y por fines visuales lo ordenamos, aunque determinar que valor es mayor si la media o la mediana no tine mucho sentido a nivel estadístico
Salario$`Medidas y percentiles` <- factor(Salario$`Medidas y percentiles`, 
                                           levels = c("Percentil 10", "Cuartil inferior",
                                                      "Mediana","Media", "Cuartil superior", "Percentil 90"), 
                                           labels = c("Percentil 10", "Cuartil inferior", 
                                                      "Mediana","Media", "Cuartil superior", "Percentil 90"),
                                           ordered = TRUE)

# Ahora con la variable sexo
inter2<-as.factor(Salario$Sexo)
Salario$Sexo<-factor(inter2,levels = levels(inter2),labels = levels(inter2))
```

Además, con el objetivo de ver si existe algún dato faltante se buscó en el fichero de Salario la presencia de algún dato faltante. Afortunadamente, en el caso de este fichero no se encontraron datos faltantes, por lo que en este caso no fue necesario emplean ningún método para solucionar esto.
```{r}
# Por último comprobamos que no tenemos ningún dato perdido
vis_miss(Salario)
```
Finalmente guardamos el nuevo fichero con los cambios.
```{r}
save(Salario,file = '../data/Salario_clean.csv')
```

```{r}
str(Vivienda)
# Aquí de igual manera que arriba debemos cambiar las comas a puntos para poder
#hacer el casteo a numeric
Vivienda$Total<-gsub(pattern = '[,]',replacement = '.',Vivienda$Total)
Vivienda$Total<-as.numeric(Vivienda$Total)
```


# Análisis preliminar del fichero Salario.

Seguidamente, con el objetivo de analizar los outliers se representó de las tres primeras variables, las categóricas; un histograma con el objetivo de ver si alguna de las categorías tenía una frecuencia de aparición anormalmente pequeña o grande. Cabe destacar que estos no son outliers en si mismos, dado que este es un concepto referido generalmente a variables numéricas, pero es importante descartar que esto ocurra con las variables categóricas. Asimismo, para las variables numéricas, que son el periodo y el total, se realizó un boxplot para ver si alguna contenia algún valor anómalo.
```{r}
# Calcular frecuencias por separado y unirlas en una tabla
tabla_combinada <- bind_rows(
  Salario %>%
    group_by(Variable = "Sexo", Valor = Sexo) %>%
    summarise(Frecuencia = n(), .groups = "drop"),
  Salario %>%
    group_by(Variable = "Comunidades_Autonomas", Valor = `Comunidades autónomas`) %>%
    summarise(Frecuencia = n(), .groups = "drop"),
  Salario %>%
    group_by(Variable = "Percentiles_Salario", Valor = `Medidas y percentiles`) %>%
    summarise(Frecuencia = n(), .groups = "drop")
)

# Calcular porcentaje dentro de cada grupo
tabla_combinada <- tabla_combinada %>%
  group_by(Variable) %>%
  mutate(Porcentaje = round(Frecuencia / sum(Frecuencia) * 100, 2))

# Definir un dominio explícito para los valores
dominio_frecuencia <- range(tabla_combinada$Frecuencia, na.rm = TRUE)
dominio_porcentaje <- range(tabla_combinada$Porcentaje, na.rm = TRUE)

# Crear y estilizar la tabla con gt y gtExtras
tabla_combinada %>%
  gt() %>%
  gt_theme_espn() %>%  # Aplicar un tema atractivo con gtExtras
  gt_color_rows(columns = "Frecuencia", palette = "viridis", domain = dominio_frecuencia) %>%  # Aplicar colores a la columna Frecuencia con dominio definido
  gt_color_rows(columns = "Porcentaje", palette = "viridis", domain = dominio_porcentaje) %>%  # Aplicar colores a la columna Porcentaje con dominio definido
  tab_header(
    title = "Frecuencias y Porcentajes por Variable",
    subtitle = "Distribución de sexo, comunidades autónomas y percentiles de salario"
  ) %>%
  fmt_number(
    columns = Porcentaje,
    decimals = 2,  # Limitar a dos decimales
    pattern = "{x}%"  # Añadir el símbolo de porcentaje
  ) %>%
  tab_options(
    table.width = px(700)  # Ajustar el ancho de la tabla
  ) %>%
  cols_align(
    align = "center",
    columns = everything()
  )

```
Como vemos no existe ninguna anomalía en las variables categóricas, dado que todas aparecen con la misma frecuencia 

# Análisis de las variables numéricas
```{r}
ggplot(Salario, aes(x =`Medidas y percentiles`, y = Total,fill =`Medidas y percentiles`)) +
  geom_boxplot()+theme(axis.text.x = element_text(angle = 45, hjust = 1))+labs(title = 'Boxplot del salario según percentil')
```
Como podemos ver, en casi todos los boxplots aparecen valores atípicos o outliers. Sin embargo, considerando que estamos analizando la evolución de los salarios a lo largo de más de 10 años, estos valores atípicos pueden ser el resultado natural del crecimiento de los salarios durante ese periodo. Además, no observamos valores extremadamente altos o bajos, lo que sugiere que no hay anomalías significativas en los datos, sino simplemente la variabilidad normal de un proceso económico que evoluciona con el tiempo.
```{r}
# Crear gráficos de barras con densidad superpuesta
library(patchwork)  # Para combinar múltiples gráficos

graficos <- lapply(percentiles_levels, function(level) {
  ggplot(Salario %>% filter(`Medidas y percentiles` == level),
         aes(x = Total, fill = `Medidas y percentiles`)) +
    geom_histogram(aes(y = ..density..), fill = "#FF4500", alpha = 0.6, bins = 30) +  # Cambiar color del histograma para contraste y aumentar transparencia
    geom_density(color = "blue", size = 1, alpha = 0.3) +  # Aumentar transparencia del gráfico de densidad
    labs(title = level, x = "Total (€)", y = "Densidad") +  # Simplificar el título
    theme_minimal() +
    theme(
      legend.position = "none",  # Eliminar la leyenda
      plot.title = element_text(size = 10)  # Reducir el tamaño del título
    )
})

# Combinar los gráficos
grafico_final <- wrap_plots(graficos, ncol = 2)

# Mostrar el conjunto de gráficos
grafico_final


```
Como podemos observar, las distribuciones no parecen ajustarse a una forma gaussiana en ninguno de los casos. Por eso, para definir la distribución, vamos a usar la mediana y el rango intercuartílico, ya que estas métricas no dependen del tipo de distribución que tengan los datos y son más fiables para describir distribuciones asimétricas o con valores atípicos

```{r}
# Crear tabla con gt para representar cada percentil con la mediana e IQR
metricas_percentiles <- Salario %>%
  group_by(`Medidas y percentiles`) %>%
  # Empleamos los parámetros robustos frente a la distribución de los datos
  summarise(
    Mediana = median(Total, na.rm = TRUE),
    IQR = IQR(Total, na.rm = TRUE)
  )

# Crear la tabla utilizando gt
tabla_metricas <- metricas_percentiles %>%
  gt() %>%
  tab_header(
    title = "Metricas de Salario por Percentil",
    subtitle = "Mediana y Rango Intercuartílico para cada percentil"
  ) %>%
  tab_options(
    table.width = px(700)  # Ajustamos el ancho de la tabla
  ) %>%
  # alineamos el contenido de las columnas
  cols_align(
    align = "center",
    columns = everything()
  )%>%
  fmt_number(
    columns = Mediana,
    suffixing = TRUE,
    pattern = "{x} €"
  )


# Mostrar la tabla
tabla_metricas

```
A partir de la tabla de las métricas de salario por percentil, podemos observar que los valores de la mediana y del rango intercuartílico (IQR) varían de manera significativa entre los diferentes percentiles. La mediana aumenta progresivamente desde 8.720 € en el percentil 10 hasta 39.090 € en el percentil 90. Esto indica un crecimiento notable de los salarios conforme se avanza a percentiles más altos.

El rango intercuartílico (IQR), que nos muestra la variabilidad en los salarios, también crece a medida que se incrementa el percentil. En los percentiles inferiores, como el cuartil inferior y el percentil 10, los valores del IQR se mantienen relativamente bajos, lo cual sugiere una menor dispersión de los salarios. Sin embargo, al avanzar hacia los percentiles superiores, como el cuartil superior y el percentil 90, el IQR incrementa considerablemente, lo cual refleja una mayor variabilidad en los salarios más altos.

Como este análisis se realiza a lo largo de los años, el hecho de que el rango intercuartílico sea más elevado en los percentiles más altos indica que quienes más han aumentado su salario son los del percentil 90. Además, existen diferencias significativas entre lo que cobra la media de la población y el cuartil inferior, lo cual resalta una mayor desigualdad salarial entre la clase media.

# Análisis del archivo Salario

Primeramente, nos centrarems en ver como ha variado el salario medio de cada comunidad autónoma a lo largo del tiempo. El objetivo de este análisis es ver como ha variado el salario medio en cada comunidad y si existe una tendencia general en las mismas.Por limitaciones de la representación solo se muestran las dos comunidades con mayor salario medio(tomando como referencia 2022) y con menor valor de este. No obstante,en la versión web creada con shiny se puede jugar con todas las comunidades autónomas.

```{r}
# Filtrando las comunidades autónomas con el valor de salario medio de 2022
primer_analisis <- Salario %>%
  filter(`Medidas y percentiles` == 'Media', 
         Sexo == 'Ambos sexos', 
         `Comunidades autónomas` != 'Total Nacional')

# Seleccionando las dos comunidades con mayor y menor salario medio en el 2022 como referencia de la tendencia a lo largo de los años
comunidades_filtradas <- primer_analisis %>%
  filter(Periodo == 2022) %>%
  slice_max(Total, n = 2) %>%
  bind_rows(slice_min(primer_analisis %>% filter(Periodo == 2022), Total, n = 2)) %>%
  select(`Comunidades autónomas`) %>%
  distinct()

# Filtrando los datos para solo incluir las comunidades seleccionadas
primer_analisis_filtrado <- primer_analisis %>%
  filter(`Comunidades autónomas` %in% comunidades_filtradas$`Comunidades autónomas`)

# Crear colores personalizados manualmente
colores_personalizados <- c("#E41A1C", "#377EB8", "#4DAF4A", "#FF7F00")

# Crear el gráfico
g1 <- ggplot(primer_analisis_filtrado, aes(x = Periodo, y = Total, color = `Comunidades autónomas`)) +
  geom_line() +
  geom_point() +
  labs(
    title = 'Evolución del Sueldo Medio por CC. AA',
    y = 'Total (€)',
    color = NULL  # Sin título en la leyenda
  ) +
  scale_color_manual(values = colores_personalizados) +  # Colores personalizados
  guides(color = guide_legend(title = NULL))  # Sin título en la leyenda

# Mostrar el gráfico
g1

```
Como se puede observar, las comunidades con mayor salario medio son el País Vasco y Madrid. Por otro lado, las comunidades con peor sueldo medio a lo largo de los años son Extremadura y Canarias. Además se puede ver una clara tendencia al alza en los últimos años, lo que demuestra que el salario medio está subiendo año a año en nuestro país.

# Mapa interactivo
```{r}
# Descargar el mapa de comunidades autónomas
mapa_espana <- esp_get_ccaa()
# Vemos si existen diferencias entre las etiquetas 
nombres_mapa<-mapa_espana$ine.ccaa.name
nombres_datos <- unique(primer_analisis$`Comunidades autónomas`)
nombres_no_coinciden <- setdiff(nombres_datos, nombres_mapa)
print(nombres_no_coinciden)
# Unir el mapa con tus datos
datos_mapa <- mapa_espana %>%
  left_join(primer_analisis, by = c("ine.ccaa.name" = "Comunidades autónomas"))

# Crear el gráfico animado
mapa_animado <- ggplot(datos_mapa) +
  geom_sf(aes(fill = Total), color = "white") +  # Color de las fronteras de las comunidades
  scale_fill_viridis_c(option = "magma", name = "Salario Medio (€)") +  # Escala de colores
  theme_minimal() +
  labs(
    title = "Evolución del Salario Medio en España ({closest_state})",
    subtitle = "Datos por Comunidad Autónoma",
    caption = "Fuente: Tus datos",
    fill = "Salario (€)"
  ) +
  transition_states(Periodo, state_length = 1, wrap = FALSE) +  # Animación por año
  ease_aes("linear")  # Suaviza las transiciones

# Renderizar el mapa animado
animate(
  mapa_animado,
  nframes = 150,  # Más cuadros
  fps = 10,        # Menor cantidad de cuadros por segundo
  width = 800,
  height = 600
)

```



Segundo análisis, referido a las discrepancias de género en el salario medio a nivel nacional primero y luego a nivel valencia a lo largo del tiempo.

```{r}
colores_personalizados3 <- c( "#377EB8","#FFC0CB")
                      
# Filtrando los datos con dplyr
segundo_análisis_A <- Salario %>%
  filter(`Comunidades autónomas` == 'Total Nacional',
         `Medidas y percentiles` == 'Media',
         Sexo != 'Ambos sexos')

# Creando la gráfica con ggplot2
g2 <- ggplot(segundo_análisis_A, aes(x = Periodo, y = Total, fill = Sexo)) +
  geom_bar(stat = "identity", position = 'dodge') +
  scale_fill_manual(values = colores_personalizados3) +
  geom_line(aes(group = Sexo, color = Sexo)) +
  geom_point(aes(color = Sexo)) +
  labs(
    title = 'Discrepancias de Género en el Salario Medio a Nivel Nacional',
    y = 'Total (€)',
    x = 'Periodo'
  ) +
  theme_minimal()

# Mostrando la gráfica
g2
```
Como se puede observar, desde el 2008 hasta el 2022 tanto el salario medio de las mujeres como el de los hombres ha experimentado un aumento sustancial. Pasando, aporximadamente de los 24000€ a los 29000€ en el caso de los hombres y de los  18000€ a los 24000€ en las mujeres. Sin embargo, y pese a que la diferencia ha diminuído con respecto a los hombres, las mujeres cobran de media aproximadamente lo mismo en el 2022 que los hombres en el 2008, dato que llama la atención y cuyas causas deberían ser estudiadas más en profundidad.


Análisis B

```{r}
colores_personalizados4 <- c("#0073B2", "#FF69B4")
# Filtrando los datos con dplyr para la Comunitat Valenciana
segundo_análisis_B <- Salario %>%
  filter(`Comunidades autónomas` == 'Comunitat Valenciana',
         `Medidas y percentiles` == 'Media',
         Sexo != 'Ambos sexos')

# Creando la gráfica con ggplot2 para la Comunitat Valenciana
g3 <- ggplot(segundo_análisis_B, aes(x = Periodo, y = Total, fill = Sexo)) +
  geom_bar(stat = "identity", position = 'dodge') +
  scale_fill_manual(values = colores_personalizados4) +
  geom_line(aes(group = Sexo, color = Sexo), linetype = "solid") +
  geom_point(aes(color = Sexo)) +
  labs(
    title = 'Discrepancias de Género en el Salario Medio a Nivel valenciano',
    y = 'Total (€)',
    x = 'Periodo'
  ) +
  theme_minimal()

# Mostrando la gráfica
g3

```
En el caso de la Comunidad Valenciana observamos que la tendencia es muy similar a lo que ocurre a nivel nacional. Produciéndose un aumento significativo de los salarios tanto en el caso de las mujeres como en el de los hombres. Además, en el caso de la Comunidad Valenciana, la diferencia de salario entre los hombres y mujeres en el 2022 estaba por debajo de la media nacional.


Análisis final referido a las discrepancias de génereo a lo largo de los años en las distintas comunidades autónomas

```{r}
# Filtramos las comunidades autónomas excluyendo "Total Nacional" y seleccionamos solo la media y el sexo que no sea "Ambos sexos"
df_filtered <- Salario %>%
  filter(`Comunidades autónomas` != 'Total Nacional', 
         `Medidas y percentiles` == 'Media', 
         Sexo != 'Ambos sexos') %>%
  select(-`Medidas y percentiles`)

# Transformamos los datos para obtener la diferencia entre Hombres y Mujeres
df_filtered <- df_filtered %>%
  pivot_wider(names_from = Sexo, values_from = Total) %>%
  mutate(diferencia = Hombres - Mujeres)

# Filtramos las comunidades con las dos mayores y las dos menores diferencias en el año 2022
df_filtered_2022 <- df_filtered %>%
  filter(Periodo == 2022) %>%
  slice_max(order_by = diferencia, n = 2) %>%
  bind_rows(slice_min(df_filtered %>% filter(Periodo == 2022), order_by = diferencia, n = 2))

# Filtramos el dataset original para obtener las comunidades seleccionadas
comunidades_seleccionadas <- df_filtered_2022$`Comunidades autónomas`

df_filtered_final <- df_filtered %>%
  filter(`Comunidades autónomas` %in% comunidades_seleccionadas)

# Graficamos las diferencias a lo largo de los años
g4 <- ggplot(df_filtered_final, aes(x = Periodo, y = diferencia, color = `Comunidades autónomas`)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colores_personalizados2) +  # Colores personalizados
  guides(color = guide_legend(title = NULL)) +
  labs(title = 'Análisis de discrepancias de género por años y comunidades',
       y = 'Diferencia (€)')

print(g4)


```
Como vemos, las comunidades con la menor diferencia de salario medio entre hombres y mujeres son las Islas Canarias, las Islas Baleares y Extremadura. Este dado es sorprendente, porque justamente las Islas Canarias y Extremadura son las dos comunidades autónomas con menor salario medio.

```{r}
colores_personalizados2 <- c("#E41A1C", "#377EB8", "#4DAF4A", "#FF7F00", "#FFFF33", "#A65628", "#984EA3", "#999999", "#FFC0CB", "#00FF00",  "#FF00FF", "#0000FF", "#FFD700", "#000000", "#666666",  "#00FFFF", "#FF4500", "#581845", "#123705", "#9588dd")
# Crear la interfaz de usuario
ui <- fluidPage(
  titlePanel("Evolución del Sueldo Medio por CC. AA"),
  sidebarLayout(
    sidebarPanel(
      sliderInput("año", "Selecciona los años a mostrar:",
                  min = min(primer_analisis$Periodo),
                  max = max(primer_analisis$Periodo),
                  value = range(primer_analisis$Periodo),
                  step = 1,
                  sep = ""),
      checkboxGroupInput("comunidades", "Selecciona las Comunidades Autónomas:",
                         choices = unique(primer_analisis$`Comunidades autónomas`),
                         selected = unique(primer_analisis$`Comunidades autónomas`))
    ),
    mainPanel(
      tabsetPanel(
        tabPanel("Evolución del Sueldo Medio", plotOutput("salarioPlot")),
        tabPanel("Análisis de Discrepancias de Género", plotOutput("discrepanciasGeneroPlot"))
      )
    )
  )
)

# Definir la lógica del servidor
server <- function(input, output) {
  # Pestaña 1: Evolución del Sueldo Medio
  output$salarioPlot <- renderPlot({
    # Filtrar los datos según los años y comunidades seleccionadas
    datos_filtrados <- primer_analisis %>%
      filter(Periodo >= input$año[1],
             Periodo <= input$año[2],
             `Comunidades autónomas` %in% input$comunidades)
    
    # Crear el gráfico con los datos filtrados
    ggplot(datos_filtrados, aes(x = Periodo, y = Total, color = `Comunidades autónomas`)) +
      geom_line() +
      geom_point() +
      labs(
        title = 'Evolución del Sueldo Medio por CC. AA',
        y = 'Total (€)',
        color = NULL  # Sin título en la leyenda
      ) +
      scale_color_manual(values = colores_personalizados2) +  # Colores personalizados
      guides(color = guide_legend(title = NULL))  # Sin título en la leyenda
  })
  
  # Pestaña 2: Análisis de Discrepancias de Género
  output$discrepanciasGeneroPlot <- renderPlot({
    # Filtrar los datos para el análisis de discrepancias de género
    df_filtered <- Salario[Salario$`Comunidades autónomas` != 'Total Nacional' &
                             Salario$`Medidas y percentiles` == 'Media' &
                             Salario$Sexo != 'Ambos sexos', ]
    df_filtered <- df_filtered[, !names(df_filtered) %in% 'Medidas y percentiles']
    # Emplear pivot_wider para transformar los datos
    df_filtered <- pivot_wider(df_filtered, names_from = Sexo, values_from = Total)
    df_filtered$diferencia <- df_filtered$Hombres - df_filtered$Mujeres
    
    # Crear el gráfico de discrepancias de género
    ggplot(df_filtered, aes(x = Periodo, y = diferencia, color = `Comunidades autónomas`)) +
      geom_line() +
      geom_point() +
      scale_color_manual(values = colores_personalizados2) +  # Colores personalizados
      guides(color = guide_legend(title = NULL)) +
      labs(title = 'Análisis de discrepancias de género por años y comunidades', y = 'Diferencia (€)')
  })
}

# Ejecutar la aplicación Shiny
shinyApp(ui = ui, server = server)


```


# Análisis del dataset Vivienda.

En este dataset se analiza el IPV (Índice de Precios de Vivienda) dependiendo del año, región o tipo de vivienda. Para poder entender correctamente el siguiente análisis, tenemos que explicar brevemente en que consiste el IPV.

El IPV tiene como principal objetivo medir la evolución del nivel de los precios de compraventa de las viviendas de precio libre, nuevas y de segunda mano, a lo largo del tiempo. Se trata, por tanto, de un indicador concebido únicamente para establecer comparaciones en el tiempo.

Una vez aclarado el concepto del IPV, pasamos al análisis de nuestro datatset.

## Evolución del IPV a lo largo de los años por región.

La principal información que recoge este dataset es el del valor del IPV a lo largo de los años. Así, empezaremos estudiando la evolución del IPV del $2007$ al $2022$. Además, aprovecharemos el hecho de que los datos están seccionados por autonomías, para comparar dicha evolución.

```{r vivienda comunidades, echo=FALSE}
#Escogemos los datos necesarios
Vivienda1<-Vivienda[Vivienda$`General, vivienda nueva y de segunda mano`=='General' & Vivienda$`Índices y tasas`=='Media anual',]

#Creamos el gráfico
ggplotly(ggplot(Vivienda1, aes(x = Periodo, y = Total, color = `Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colores_personalizados) +
  labs(
    title = 'Evolución del IPV por Comunidades Autónomas',
    y = 'IPV',
    x = 'Año',
    color = NULL  # Sin título en la leyenda
  ) +
  guides(color = guide_legend(title = NULL)))  # Sin título en la leyenda
```

Como podemos ver, el IPV sufrió una gran caída a partir del año $2008$, posiblemente por el estallido de la burbuja inmobiliaria. Dicha caída continua hasta frenarse en el año $2015$, donde sigue una subida constante hasta la actualidad.

Respecto a la comparativa por autonomías, vemos como Madrid, Cataluña y Canarias  obtienen los mayores valores del IPV actual, por encima del valor nacional. Por otro lado, Extremadura, Navarra y las castillas tienen el IPV más bajo de todas las comunidades autónomas.

Esta diferencia de valores puede ser motivo de las preferencias del sector turístico, pues Madrid, Cataluña y Canarias son comunidades altamente turísticas, en contraste a las otras comunidades.

## Vivienda nueva y de segunda mano

El dataset también nos ofrece información sobre la diferencia entre el IPV de viviendas nuevas y de segunda mano.

```{r tipos de vivienda, echo=FALSE}
#Escogemos los datos necesarios
Vivienda2<-Vivienda[Vivienda$`Comunidades y Ciudades Autónomas`=='Nacional' & Vivienda$`Índices y tasas`=='Media anual' & Vivienda$`General, vivienda nueva y de segunda mano`!='General',]

#Elegimos colores para el gráfico
col2 <- c("#E41A1C", "#377EB8", "#4DAF4A")

#Crear el gráfico
ggplotly(
  ggplot(Vivienda2,aes(x = Periodo, y = Total, fill = `General, vivienda nueva y de segunda mano`)) +
    geom_bar(stat = "identity",position = 'dodge') +
    scale_fill_manual(values = col2) +
    geom_line() +
    geom_point() +
    labs(
    title = 'Evolución del IPV nacional por tipo de vivienda',
    y = 'IPV',
    x = 'Año',
    fill = "Tipo de vivienda"
    )
  )
```

Como podemos observar, $2015$ vuelve a ser un punto de inflexión, pues en este caso pasamos de ver un IPV mayor en las viviendas de segunda mano, a un mayor IPV en las nuevas viviendas.

Nos centramos ahora en la Comunidad Valenciana, donde observamos la siguiente evolución.

```{r tipos de vivienda valencia, echo=FALSE}
#Escogemos los datos necesarios
Vivienda3<-Vivienda[Vivienda$`Comunidades y Ciudades Autónomas`=='10 Comunitat Valenciana' & Vivienda$`Índices y tasas`=='Media anual' & Vivienda$`General, vivienda nueva y de segunda mano`!='General',]

#Creamos el gráfico
ggplotly(
  ggplot(Vivienda3,aes(x = Periodo, y = Total, fill = `General, vivienda nueva y de segunda mano`)) +
    geom_bar(stat = "identity",position = 'dodge') +
    scale_fill_manual(values = col2) +
    geom_line() +
    geom_point() +
    labs(
    title = 'Evolución del IPV por tipo de vivienda en la Comunidad Valenciana',
    y = 'IPV',
    x = 'Año',
    fill = "Tipo de vivienda"
    )
  )
```

Como vemos, la Comunidad Valenciana sigue la misma tendencia que el resto de España, aunque en este caso la diferencia entre el IPV de viviendas nuevas y de segunda mano es considerablemente mayor.

# Conclusion

This section is not mandatory, but can be added to the manuscript if the
discussion is unusually long or complex.
