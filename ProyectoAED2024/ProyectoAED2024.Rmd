---
title: Evolución y comparativa del precio de la vivienda y el salario medio
author:
  - name: Rodrigo Juanes Busolo
  - name: Noé López García
  - name: Marc Velasco Mateu
# document options
type: article
# front matter
simplesummary: |
  Con tal de poner a prueba nuestros conocimientos de análisis exploratorio de datos, analizaremos detenidamente datasets sobre el valor de la vivienda española, el salario medio en España y el precio por metro cuadrado en la ciudad de Valencia.
abstract: |
  Aquí ponemos el abstract.
# back matter
acknowledgement: |
  Gracias a Marcelino Martinez Sober y a Juan Gomez Sanchis.
abbreviations:
  - short: CCAA
    long: Comunidades autónomas
bibliography: mybibfile.bib
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

```{r carga de librerias, include=FALSE}
library(readr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(scales)
library(patchwork)
library(plotly)
library(lubridate)
library(corrplot)
library(skimr)
library(maps)
library(mapdata)
library(mapSpain)
library(tidyverse)
library(forcats)
```

```{r limpieza, include=FALSE}
rm(list = ls())
```

# Introduction

The introduction should briefly place the study in a broad context and highlight
why it is important. It should define the purpose of the work and its
significance. The current state of the research field should be reviewed
carefully and key publications cited. Please highlight controversial and
diverging hypotheses when necessary. Finally, briefly mention the main aim of
the work and highlight the principal conclusions. As far as possible, please
keep the introduction comprehensible to scientists outside your particular
field of research. Citing a journal paper [@bertrand-krajewski_distribution_1998;
@leutnant_stormwater_2016]. And now citing a book reference @gujer_systems_2008.
Some MDPI journals use Chicago and others use APA, this template should choose
the correct citation format for you once you specify the journal in the YAML
header.

# Lista de ideas

* librería vismis (representación de valores faltantes)
* Discutir y justificar (sí o sí) si imputar o no los datos de Ceuta y Melilla
* Justificar outliers
* Añadir cuadro de mandos cuando sea posible
* Librería arsenal
* Homogeneizar
* Estilizar
* Ratio salario vivienda

# Carga de los archivos

```{r}
# Especificamos que la columna total de Salario sea de tipo character para no perder las comas al importarlo como double
Salario <- read_delim("../data/Salario.csv", delim = ";", escape_double = FALSE, col_types = cols(Total = col_character()), trim_ws = TRUE)
# Con vivienda no es necesario porque como se ve en la herramienta la columna se importa como character
Vivienda <- read_delim("../data/Vivienda.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)
```

Inicialmente ejecutamos el comando str para obervar el aspecto que tienen los datos. Además, este comando nos permite visualizar el tipo de dato que contiene cada columna, lo que nos permite visualizar si alguna de ellas debería ser convertida a otro tipo de dato más acorde a la información que contiene. 
En nuestro caso, para el fichero de salario se detectó que la variable total contenía un tipo de dato str, cuando lo lógico es que esta columna sea de tipo numérico.Esto se realizó de manera intencionada al importar los datos, dado que en el INE se emplean comas para separar los decimales, algo que en R se realiza con puntos. Por ello, y para evitar conflictos; se importó como una cadena de texto y luego se realizaron las operaciones siguientes para darle el formato adecuado. Primeramente, como el punto también fue empleado para mostrar la separación de los miles, se sustituyó este elemento por vacío. Seguidamente, las comas fueron sustiuidas por puntos, para finalmente mediante el comando as.numeric convertir los datos de tipo string a numeric.
Además, dado que la variable de medias y percentiles es de tipo categórico y solo puede tomar un número finito de valores, esta fue convertida a factor. Del mismo modo, realizaremos esta conversión con la variable sexo.

```{r}
str(Salario)
# Como se puede ver el problema de la variable Total es que tiene comas y puntos,
# pero en R las comas no son interpretadas con la intención del archivo, por lo que
# pasamos a cambiar el formato, y una vez con este correcto hacer un casteo a numérico

# Primero eliminamos los puntos, que se emplean en el archivo original para hacer la
#distinción de 1000
Salario$Total<-gsub(pattern = '[.]',replacement = '',Salario$Total)
# Seguidamente cambiamos las comas por puntos para adecuarlo al formato de R
Salario$Total<-gsub(pattern = '[,]',replacement = '.',Salario$Total)
# Ahora finalmente hacemos el casteo a numeric
Salario$Total<-as.numeric(Salario$Total)
# Además la variable media y percentiles solo puede tener esos valores, por lo que la 
#transformamos en un factor
inter<-as.factor(Salario$`Medidas y percentiles`)
Salario$`Medidas y percentiles`<-factor(inter,levels = levels(inter),labels = levels(inter))
# Ahora con la variable sexo
inter2<-as.factor(Salario$Sexo)
Salario$Sexo<-factor(inter2,levels = levels(inter2),labels = levels(inter2))
```

Además, con el objetivo de ver si existe algún dato faltante se buscó en el fichero de Salario la presencia de algún dato faltante. Afortunadamente, en el caso de este fichero no se encontraron datos faltantes, por lo que en este caso no fue necesario emplean ningún método para solucionar esto.

```{r}
# Por último comprobamos que no tenemos ningún dato perdido
datos_perdidos_salario<-print(Salario[is.na(Salario)])
```
Finalmente guardamos el nuevo fichero con los cambios.
```{r}
save(Salario,file = '../data/Salario_clean.csv')
```

```{r}
str(Vivienda)
# Aquí de igual manera que arriba debemos cambiar las comas a puntos para poder
#hacer el casteo a numeric
Vivienda$Total<-gsub(pattern = '[,]',replacement = '.',Vivienda$Total)
Vivienda$Total<-as.numeric(Vivienda$Total)
```


# Análisis preliminar del fichero Salario.

Primeramente, se observó el conjunto de datos empleando el comando summary. Además se muestra en una tabla el mayor y el menor valor obtenido al realizar este comando de la variable total.

```{r}
resumen_total_salario<-summary(Salario$Total)
# Buscamos las filas donde se encuentran el máximo y el mínimo  
max_salario<-Salario[Salario$Total==resumen_total_salario['Max.'],]
min_salario<-Salario[Salario$Total==resumen_total_salario['Min.'],]
resumen<-rbind(max_salario,min_salario)
row.names(resumen)<-c('Salario máximo','Salario Mínimo')
kable_styling(kbl(resumen,align = 'c'))
```
Seguidamente, con el objetivo de analizar los outliers se representó de las tres primeras variables, las categóricas; un histograma con el objetivo de ver si alguna de las categorías tenía una frecuencia de aparición anormalmente pequeña o grande. Cabe destacar que estos no son outliers en si mismos, dado que este es un concepto referido generalmente a variables numéricas, pero es importante descartar que esto ocurra con las variables categóricas. Asimismo, para las variables numéricas, que son el periodo y el total, se realizó un boxplot para ver si alguna contenia algún valor anómalo.
```{r}
# Generar histogramas de variables categóricas
hist1 <- ggplot(Salario, aes(x = Sexo)) + 
  geom_bar(fill = "skyblue") +
  theme_minimal() + 
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("Sexo")

# Para este segundo creamos un df provisional para obtener unas abreviaturas y simplificar
# la representación 
# Crear una copia de df y añadir la columna de abreviaturas
df_abrev <- Salario

# Diccionario de abreviaturas
abreviaturas <- c(
  "Andalucía" = "AND", "Aragón" = "AR", "Asturias, Principado de" = "AST",
  "Balears, Illes" = "BAL", "Canarias" = "CAN", "Cantabria" = "CNT",
  "Castilla y León" = "CYL", "Castilla - La Mancha" = "CLM", "Cataluña" = "CAT",
  "Comunitat Valenciana" = "CV", "Extremadura" = "EXT", "Galicia" = "GAL",
  "Madrid, Comunidad de" = "MAD", "Murcia, Región de" = "MUR",
  "Navarra, Comunidad Foral de" = "NAV", "País Vasco" = "PV", 
  "Rioja, La" = "RIO", "Ceuta" = "CEU", "Melilla" = "MEL", "Total Nacional" = "TN"
)

# Crear la columna con abreviaturas en el nuevo data frame
df_abrev$ComunidadAbrev <- abreviaturas[df_abrev$`Comunidades autónomas`]

hist2 <- ggplot(df_abrev, aes(x =ComunidadAbrev)) + 
  geom_bar(fill = "salmon") +
  theme_minimal() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("Comunidades autónomas")

hist3 <- ggplot(Salario, aes(x = `Medidas y percentiles`)) + 
  geom_bar(fill = "lightgreen") +
  theme_minimal() + 
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("Medidas y percentiles")

# Generar boxplots de variables numéricas
box1 <- ggplot(Salario, aes(y = Periodo)) + 
  geom_boxplot(fill = "plum") +
  theme_minimal() + 
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("Periodo")

box2 <- ggplot(Salario, aes(y = Total)) + 
  geom_boxplot(fill = "lightcoral") +
  theme_minimal() + 
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle("Total")

# Combinar los gráficos en una cuadrícula 3x2 usando patchwork
layout <- (hist1 | hist2 | hist3) / (box1 | box2 | plot_spacer())

# Mostrar el gráfico final
layout

```
Como se puede observar para las vaiables categóricas y,pese a que en el eje x no podamos distinguirlas bien; en todas ellas las frecuencias son regulares, por lo que no existe evidencia de que haya valores inusualmente frecuentes o infrecuentes. En el caso del periodo vemos que no existe ningún año que aparezca como un dato anómalo,lo que demuestra que no hay presencia de algún año mal etiquetado o erróneo. En el caso de Total, podemos ver que la gran mayoría de los datos se centra en torno a 20000€, y que por tanto se detectan como outliers algunos valores superiores a 50000€. Sin embargo, si nos centramos en el contexto del archivo que estamos analizando, este cuenta con percentiles 90, es decir con el salario de personas que cobran más que el 90 por ciento de la población a nivel nacional o de comunidad en un determinado año. Por tanto, estos valores que se detectan como anómalos no son tales, sino que simplemente son valores elevados que están muy alejados de la media del archivo. Lo interesante es que no observamos ningún 600000€ o ningún 0, datos que carecerían de sentido en este análisis. Por tanto, podemos concluir que en este fichero no aparecen datos anómalos o outliers. 

# Análisis del archivo Salario

Primeramente, nos centrarems en ver como ha variado el salario medio de cada comunidad autónoma a lo largo del tiempo. El objetivo de este análisis es ver como ha variado el salario medio en cada comunidad y si existe una tendencia general en las mismas.

```{r}
primer_analisis<-Salario[Salario$`Medidas y percentiles`=='Media'&Salario$Sexo=='Ambos sexos'& Salario$`Comunidades autónomas`!='Total Nacional',]

# Crear colores personalizados manualmente
colores_personalizados <- c("#E41A1C", "#377EB8", "#4DAF4A", "#FF7F00", "#FFFF33",                              "#A65628", "#984EA3", "#999999", "#FFC0CB", "#00FF00", 
                            "#FF00FF", "#0000FF", "#FFD700", "#000000", "#666666", 
                           "#00FFFF", "#FF4500", "#581845", "#123705", "#9588dd")

# Crear el gráfico
g1<-ggplot(primer_analisis, aes(x = Periodo, y = Total, color = `Comunidades autónomas`)) +
  geom_line() +
  geom_point() +
  labs(
    title = 'Evolución del Sueldo Medio en Comunidades Autónomas',
    y = 'Total (€)',
    color = NULL  # Sin título en la leyenda
  ) +
  scale_color_manual(values = colores_personalizados) +  # Colores personalizados
  guides(color = guide_legend(title = NULL))  # Sin título en la leyenda

g1_interactivo<-ggplotly(g1)
g1_interactivo
```
Como se puede observar, las comunidades con mayor salario medio son el País Vasco y Madrid. Por otro lado, las comunidades con peor sueldo medio a lo largo de los años son Extremadura y Canarias. Además se puede ver una clara tendencia al alza en los últimos años, lo que demuestra que el salario medio está subiendo año a año en nuestro país.

Segundo análisis, referido a las discrepancias de género en el salario medio a nivel nacional primero y luego a nivel valencia a lo largo del tiempo.

```{r}
colores_personalizados2 <- c( "#377EB8","#FFC0CB")
                      
segundo_análisis_A<-Salario[Salario$`Comunidades autónomas`=='Total Nacional'& Salario$`Medidas y percentiles`=='Media'&Salario$Sexo!='Ambos sexos',]
g2<-ggplot(segundo_análisis_A,aes(x=Periodo,y=Total, fill=Sexo)) + geom_bar(stat = "identity",position = 'dodge')+scale_fill_manual(values = colores_personalizados2)+geom_line()+geom_point()+labs(
    title = 'Discrepancias de Género en el Salario Medio a Nivel Nacional',
    y = 'Total (€)')
g2_interactivo<-ggplotly(g2)
g2_interactivo
```
Como se puede observar, desde el 2008 hasta el 2022 tanto el salario medio de las mujeres como el de los hombres ha experimentado un aumento sustancial. Pasando, aporximadamente de los 24000€ a los 29000€ en el caso de los hombres y de los  18000€ a los 24000€ en las mujeres. Sin embargo, y pese a que la diferencia ha diminuído con respecto a los hombres, las mujeres cobran de media aproximadamente lo mismo en el 2022 que los hombres en el 2008, dato que llama la atención y cuyas causas deberían ser estudiadas más en profundidad.


Análisis B

```{r}
colores_personalizados3 <- c("#0073B2", "#FF69B4")
segundo_análisis_B<-Salario[Salario$`Comunidades autónomas`=='Comunitat Valenciana'& Salario$`Medidas y percentiles`=='Media'&Salario$Sexo!='Ambos sexos',]
g3<-ggplot(segundo_análisis_B,aes(x=Periodo,y=Total, fill=Sexo)) + geom_bar(stat = "identity",position = 'dodge')+scale_fill_manual(values = colores_personalizados3)+geom_line()+geom_point()+labs(
    title = 'Discrepancias de Género en el Salario Medio a Nivel valenciano',
    y = 'Total (€)')
g3_interactivo<-ggplotly(g3)
g3_interactivo
```
En el caso de la Comunidad Valenciana observamos que la tendencia es muy similar a lo que ocurre a nivel nacional. Produciéndose un aumento significativo de los salarios tanto en el caso de las mujeres como en el de los hombres. Además, en el caso de la Comunidad Valenciana, la diferencia de salario entre los hombres y mujeres en el 2022 estaba por debajo de la media nacional.


Análisis final referido a las discrepancias de génereo a lo largo de los años en las distintas comunidades autónomas

```{r}
library(tidyr)
df_filtered<-Salario[Salario$`Comunidades autónomas`!='Total Nacional'&Salario$`Medidas y percentiles`=='Media'& Salario$Sexo!='Ambos sexos',]
df_filtered<-df_filtered[,!names(df_filtered)%in%'Medidas y percentiles']
# Empleamos pivot wider para poder hacer la diferencia de manera más sencilla
df_filtered<-pivot_wider(df_filtered,names_from=Sexo,values_from=Total)
df_filtered$diferencia<-df_filtered$Hombres-df_filtered$Mujeres
g4<-ggplot(df_filtered,aes(x=Periodo,y=diferencia,color =`Comunidades autónomas` ))+geom_line()+geom_point()+
 scale_color_manual(values = colores_personalizados) +  # Colores personalizados
  guides(color = guide_legend(title = NULL))+
  labs(title = 'Análisis de discrepancias de género por años y comunidades',y='Diferencia (€)')
g4_interactivo<-ggplotly(g4)
g4_interactivo
```
Como vemos, las comunidades con la menor diferencia de salario medio entre hombres y mujeres son las Islas Canarias, las Islas Baleares y Extremadura. Este dado es sorprendente, porque justamente las Islas Canarias y Extremadura son las dos comunidades autónomas con menor salario medio.

# Análisis del dataset Vivienda.

En este dataset se analiza el IPV (Índice de Precios de Vivienda) dependiendo del año, región o tipo de vivienda. Para poder entender correctamente el siguiente análisis, tenemos que explicar brevemente en que consiste el IPV.

El IPV tiene como principal objetivo medir la evolución del nivel de los precios de compraventa de las viviendas de precio libre, nuevas y de segunda mano, a lo largo del tiempo. Se trata, por tanto, de un indicador concebido únicamente para establecer comparaciones en el tiempo.

Una vez aclarado el concepto del IPV, pasamos al análisis de nuestro datatset.

## Evolución del IPV a lo largo de los años por región.

La principal información que recoge este dataset es el del valor del IPV a lo largo de los años. Así, empezaremos estudiando la evolución del IPV del $2007$ al $2022$. Además, aprovecharemos el hecho de que los datos están seccionados por autonomías, para comparar dicha evolución.

```{r vivienda comunidades, echo=FALSE}
#Escogemos los datos necesarios
Vivienda1<-Vivienda[Vivienda$`General, vivienda nueva y de segunda mano`=='General' & Vivienda$`Índices y tasas`=='Media anual',]

#Creamos el gráfico
ggplotly(ggplot(Vivienda1, aes(x = Periodo, y = Total, color = `Comunidades y Ciudades Autónomas`)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = colores_personalizados) +
  labs(
    title = 'Evolución del IPV por Comunidades Autónomas',
    y = 'IPV',
    x = 'Año',
    color = NULL  # Sin título en la leyenda
  ) +
  guides(color = guide_legend(title = NULL)))  # Sin título en la leyenda
```

Como podemos ver, el IPV sufrió una gran caída a partir del año $2008$, posiblemente por el estallido de la burbuja inmobiliaria. Dicha caída continua hasta frenarse en el año $2015$, donde sigue una subida constante hasta la actualidad.

Respecto a la comparativa por autonomías, vemos como Madrid, Cataluña y Canarias  obtienen los mayores valores del IPV actual, por encima del valor nacional. Por otro lado, Extremadura, Navarra y las castillas tienen el IPV más bajo de todas las comunidades autónomas.

Esta diferencia de valores puede ser motivo de las preferencias del sector turístico, pues Madrid, Cataluña y Canarias son comunidades altamente turísticas, en contraste a las otras comunidades.

## Vivienda nueva y de segunda mano

El dataset también nos ofrece información sobre la diferencia entre el IPV de viviendas nuevas y de segunda mano.

```{r tipos de vivienda, echo=FALSE}
#Escogemos los datos necesarios
Vivienda2<-Vivienda[Vivienda$`Comunidades y Ciudades Autónomas`=='Nacional' & Vivienda$`Índices y tasas`=='Media anual' & Vivienda$`General, vivienda nueva y de segunda mano`!='General',]

#Elegimos colores para el gráfico
col2 <- c("#E41A1C", "#377EB8", "#4DAF4A")

#Crear el gráfico
ggplotly(
  ggplot(Vivienda2,aes(x = Periodo, y = Total, fill = `General, vivienda nueva y de segunda mano`)) +
    geom_bar(stat = "identity",position = 'dodge') +
    scale_fill_manual(values = col2) +
    geom_line() +
    geom_point() +
    labs(
    title = 'Evolución del IPV nacional por tipo de vivienda',
    y = 'IPV',
    x = 'Año',
    fill = "Tipo de vivienda"
    )
  )
```

Como podemos observar, $2015$ vuelve a ser un punto de inflexión, pues en este caso pasamos de ver un IPV mayor en las viviendas de segunda mano, a un mayor IPV en las nuevas viviendas.

Nos centramos ahora en la Comunidad Valenciana, donde observamos la siguiente evolución.

```{r tipos de vivienda valencia, echo=FALSE}
#Escogemos los datos necesarios
Vivienda3<-Vivienda[Vivienda$`Comunidades y Ciudades Autónomas`=='10 Comunitat Valenciana' & Vivienda$`Índices y tasas`=='Media anual' & Vivienda$`General, vivienda nueva y de segunda mano`!='General',]

#Creamos el gráfico
ggplotly(
  ggplot(Vivienda3,aes(x = Periodo, y = Total, fill = `General, vivienda nueva y de segunda mano`)) +
    geom_bar(stat = "identity",position = 'dodge') +
    scale_fill_manual(values = col2) +
    geom_line() +
    geom_point() +
    labs(
    title = 'Evolución del IPV por tipo de vivienda en la Comunidad Valenciana',
    y = 'IPV',
    x = 'Año',
    fill = "Tipo de vivienda"
    )
  )
```

Como vemos, la Comunidad Valenciana sigue la misma tendencia que el resto de España, aunque en este caso la diferencia entre el IPV de viviendas nuevas y de segunda mano es considerablemente mayor.

#Análisis de precio por metro cuadrado en compra de pisos en la ciudad de Valencia por la plataforma Fotocasa

En este último apartado del trabajo, se procede a examinar la evolución del precio de metro cuadrado en la compra de pisos en la ciudad de Valencia en los años de 2010 y 2022 y comparar posteriormente cuanto supone la inversión respecto al salario medio de la comunidad Valenciana.

```{r}
# Leer el dataset
fotocasa_compra <- read.csv("../data/precio-de-compra-en-fotocasa.csv", header = TRUE, sep = ";")
#Primeras filas
head(fotocasa_compra)
```
 
El conjunto de datos de la plataforma Fotocasa responde al precio del metro cuadrado compra de viviendas en la ciudad de Valencia. Se presentan datos de precio en los años de 2010 y 2022, con información sobre el distrito, barrio, precio de metro cuadrado y máximos históricos. Las columnas Geo.Point y Geo.Shape contienen información sobre las coordenadas geográficas sobre el bario y su entensión en la ciudad de valencia. Referente a los códigos, el de distrito diferencia unequívocamente los distritos de la ciudad de Valencia, mientras que el de barrio numeran los distintos barrios que conforman el distrito. Por ello, la columna de codigo de distrito/barrio identifica de forma única cada barrio de la ciudad de Valencia. Por ejemplo, el barrio de Benimamet tiene el código 1 del distrito de Poblados del Oeste, que tiene código de distrito 18. Por lo tanto su código de distrito/barrio sería 181.

El primer paso consiste en renombrar las columnas a nombres más sencillos y fáciles de trabajar, asi como eliminar la columna de fecha, que no aporta información relevante para el análisis.
 
```{r}
#Drop de columna FECHA
fotocasa_compra$Fecha_creacion <- NULL

#Renombrar columnas
colnames(fotocasa_compra) <- c("GEO_P","GEO_S", "CODDISTBAR", "CODBAR", "CODDIS", "DISTRITO", "M2_2022", "M2_2010", "M2_MAX", "AÑO_MAX", "BARRIO")
fotocasa_compra

```

```{r}
#Resumen de la estructura del dataset
str(fotocasa_compra)
```

A la vista de la estructura del dataset, se observa que la mayoría de las variables son de tipo numérico, excepto aquellas de coordenadas geográficas que son de tipo character, así como el distrito, el barrio o el año (siendo estas tres últimas convertibles a caracter o factor) y las referentes a coordendas geográficas.
 
```{r}
#Trasformar tipo de CODISTBAR , CODDIS y CODBAR a caracter
fotocasa_compra$CODDISTBAR <- as.character(fotocasa_compra$CODDISTBAR)
fotocasa_compra$CODDIS <- as.character(fotocasa_compra$CODDIS)
fotocasa_compra$CODBAR <- as.character(fotocasa_compra$CODBAR)
```


```{r}
summary(fotocasa_compra)
```
La mayoría de las variables son de tipo numérico, así que aquellas únicamente numéricas contínuas son las del precio en los años de 2010, 2022 y máximos históricos. No obstante, antes de analizar con las métricas de resumen, hay que realizar un análisis de valores faltantes y duplicados, así como la presencia de valores anómalos que puedan afectar al posterior análisis.


```{r}
#Comprobar si hay filas duplicadas
duplicados <- fotocasa_compra[duplicated(fotocasa_compra),]
duplicados
```

No existen filas duplicadas dentro del conjunto de datos. Ahora se procede a comprobar si hay valores nulos en el mismo.

```{r}
# Exploración de datos faltantes
colSums(is.na(fotocasa_compra))
```

Hay 18 valores nulos en columnas de máximos históricos y precios de metro cuadrado. Se verifica que barrios son los que tienen valores nulos y a qué distritos pertenecen. Se sabe que los valores faltantes son referentes a los años y precios de metro cuadrado.

```{r}
#Exponer filas con valores nulos
fotocasa_compra[!complete.cases(fotocasa_compra),]%>% 
  group_by(DISTRITO) %>% 
  summarise(n = n())
 
```

Parece que todos son barrios pertenecientes al distrito de poblados del norte, sur y oeste. Cabe responder a la pregunta de si hay distritos completos sin datos o solamente son barrios sueltos dentro de esos distritos.
 
```{r}
#Agrupar por distrito, solo seleccionar distritos POBLATS DE LOEST, POBLATS DEL NORD, POBLATS DEL SUD
fotocasa_compra %>% 
  filter(DISTRITO %in% c("POBLATS DE LOEST", "POBLATS DEL NORD", "POBLATS DEL SUD")) %>% 
  group_by(DISTRITO) %>% 
  summarise(n = n())
```
```{r}
#Exponer distritos POBLATS DE LOEST, POBLATS DEL NORD, POBLATS DEL SUD, con variables de precio
fotocasa_compra %>% 
  filter(DISTRITO %in% c("POBLATS DE LOEST", "POBLATS DEL NORD", "POBLATS DEL SUD")) %>% 
  select(DISTRITO,BARRIO, M2_2022, M2_2010, M2_MAX, AÑO_MAX)

```



Como resultado se observa que de 3 distritos completos no tendremos datos. Esto supone un gran problema, porque su manejo es un problema. No podemos eliminarlos porque suponen una pérdida importante en la representación del conjunto de datos. El mejor caso sería imputarlos. Si tuviéramos un dato no nulo pertenenciente a algún barrio dentro de esos distritos podríamos imputar ese mismo valor para el resto, pero no es el caso. Podemos aproximar el valor mediante barrios adyacentes, pero tampoco sería una representación totalmente fiel.

Como solución, se procede a imputar los valores faltantes del año 2022 mediante los datos presentados en el portal de búsqueda de inmuebles de Indomio (https://www.indomio.es/mercado-inmobiliario/comunitat-valenciana/valencia-capital/). Se ha tomado como referencia el máximo del año.
Para el caso de 2010, no se ha encontrado información suficiente para realizar una imputación correcta, por lo se decide aproximar por el precio de 2010 de aquellos barrios con un precio por metro cuadrado similar al de los barrios con valores faltantes en 2022.



```{r}
# Mostrar media de precio por distrito, filtrado entre 1300 y 1450
fotocasa_compra %>% 
  group_by(DISTRITO) %>% 
  summarise(M2_2022 = mean(M2_2022)) %>%  filter(M2_2022 < 1450) 
```
Vemos que el distrito que más se asemeja es el de L'olivereta con 1401 €/m2. Vamos a imputar los valores faltantes de 2022 con este valor.
En resumen, los valores finales son:

* POBLATS DEL SUD: 2022 <- 1399 €/m2 , 2010 <- 1401 €/m2
* POBLATS DEL NORD: 2022 <- 1352 €/m2, 2010 <- 1401 €/m2
* POBLATS DE LOEST: 2022 <- 1386 €/m2, 2010 <- 1401 €/m2

```{r}
#Insertar valores faltantes correspondientemente
fotocasa_compra$M2_2022[fotocasa_compra$DISTRITO == "POBLATS DEL SUD"] <- 1399
fotocasa_compra$M2_2022[fotocasa_compra$DISTRITO == "POBLATS DEL NORD"] <- 1352
fotocasa_compra$M2_2022[fotocasa_compra$DISTRITO == "POBLATS DE LOEST"] <- 1386
fotocasa_compra$M2_2010[fotocasa_compra$DISTRITO %in% c("POBLATS DEL SUD", "POBLATS DEL NORD", "POBLATS DE LOEST")] <- 1401
```

```{r}
#Resultado
fotocasa_compra %>% 
  filter(DISTRITO %in% c("POBLATS DE LOEST", "POBLATS DEL NORD", "POBLATS DEL SUD")) %>% 
  select(DISTRITO,BARRIO, M2_2022, M2_2010, M2_MAX, AÑO_MAX)
```


Tras esto, se ratifica si los valores de precio máximo son los correctos. Solo los podemos cotejar con aquellos de los años 2010 y 2022 que son las columnas a las que tenemos acceso, pero aún así, el valor debería ser mínimo que aquellos dos presentados durante esos dos años.



```{r}
# Comprobar que valores máximos son mayores que los de 2010 y 2022
fotocasa_compra %>% 
  filter(M2_MAX < M2_2010 | M2_MAX < M2_2022) %>% 
  select(BARRIO, M2_2022, M2_2010, M2_MAX, AÑO_MAX)

```
 
Se examina 9 casos donde el máximo histórico es menor que el precio de 2010 o 2022. Esto puede deberse a un error humano o de recogida de datos. No puede ser un error de registro, pues todos han sido registrados durante el año 2023 y los registros más recientes son del año 2022. 

Una vez más salta la pregunta de cómo corregir estos errores en la obtención de los datos. No sería lo más acertado asignar el valor máximo de la columna de 2010 o de 2022 porque no sabemos a ciencia cierta si son los valores máximos al no tener registros de otros años. Una solución consistiría en buscar información cotejada de otras fuentes fiables sobre los valores oportunos o reclamar a la fuente de los datos para que corrijan los errores y presente un conjunto de datos más consistente.

Para este caso, y con el objetivo de corregir lo máximo el conjunto de datos, se cambia el valor máximo por el valor más alto de los dos años, 2010 y 2022. Así además se termina de imputar los datos faltantes de los tres distritos con valores nulos

```{r}
# Seleccionar precio máximo entre las dos variables y escribirlo en M2_MAX y el año en AÑO_MAX
fotocasa_compra$M2_MAX <- pmax(fotocasa_compra$M2_2022, fotocasa_compra$M2_2010)
fotocasa_compra$AÑO_MAX <- ifelse(fotocasa_compra$M2_MAX == fotocasa_compra$M2_2022, "2022", "2010")
```

```{r}
fotocasa_compra %>% 
  filter(M2_MAX < M2_2010 | M2_MAX < M2_2022) %>% 
  select(BARRIO, M2_2022, M2_2010, M2_MAX, AÑO_MAX)
```

```{r}
#Resultado
fotocasa_compra %>% 
  select(DISTRITO,BARRIO, M2_2022, M2_2010, M2_MAX, AÑO_MAX)
```
Con esto finalizamos el análisis de valores nulos e incongruencias en el conjunto de datos. Para el próximo apartado se procede al análisis de los datos (anomalías entre otras ocurrencia) y a la visualización de los mismos para continuar con la línea investigativa del trabajo.

 
## Análisis univariable

```{r}
# Boxplot para detectar outliers en cada variable numérica
fotocasa_compra %>% 
  select(where(is.numeric)) %>%
  gather(key = "Precio_m2", value = "Euros") %>%
  ggplot(aes(x = Precio_m2, y = Euros, fill = Precio_m2))  +
  geom_boxplot(alpha = 0.7) + 
  labs(title = "Boxplot de precios por metro cuadrado") + 
  theme_minimal()
```
```{r}
#Media las variables numéricas, por filar y ordenadas
fotocasa_compra %>% 
  select(where(is.numeric)) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  gather(key = "Variable", value = "Valor") %>% 
  arrange(Valor)

  
```
```{r}
#Valores máximos y mínimos de las variables numéricas
fotocasa_compra %>% 
  select(where(is.numeric)) %>% 
  summarise_all(range, na.rm = TRUE) %>% 
  gather(key = "Variable", value = "Valor") %>% 
  arrange(Valor)
```
Del resultado de la gráfica de caja y bigotes podemos observar que la tendencia evolutiva de los precios a sido a la alza. La media para el año de 2010 fue de 1677,193€/m2, mientras que para el año 2022 fue de 1959,330€/m2. El precio máximo histórico fue de 2022.193€/m2 en el año 2022, mientras que el precio mínimo fue de 1677.193€/m2 en el año 2010. Esto supone un incremento de 282.137€/m2 en 12 años. El diagrama también muestra que el primer cuartil es similar en ambos años, mientras que el tercer cuartil es mayor en el año 2022. Esto indica que la distribución de los precios de 2022 es más dispersa que la de 2010. Esto se nota aún más en los máximos y mínimos. Los valores de 2010 se centraban en el rango de los 1162€/m2 a los 2455€/m2, mientras que en 2022 se centran en el rango de los 1103€/m2 a los 4029€/m2. Sorprende la presencia de valores tan altos en 2022, duplicando el precio máximo de 2010 en casi un 60%. Por otro lado, los mínimos de ambos años son muy similares, lo que indica que los precios mínimos no han variado mucho en estos 12 años.   

Como observación, en el año 2022 existe un dato anómalo que se aleja mucho del resto de los datos. Este valor anómalo es el precio de 4029€/m2. Este valor es un 60% mayor que el precio máximo de 2010. Se comprueba qué barrio es y a que distrito pertenece.

```{r}
#Seleccionar filas con valores máximos del 2022
fotocasa_compra %>% 
  filter(M2_2022 == 4029) %>%
  select(DISTRITO, BARRIO, M2_2010, M2_2022, M2_MAX, AÑO_MAX)

```
```{r}
fotocasa_compra %>% 
  filter(DISTRITO == "CAMPANAR") %>%
  select(DISTRITO, BARRIO, M2_2010, M2_2022, M2_MAX, AÑO_MAX)
```

El barrio resultantes es El pla del, del distrito de L'eixample. En su comparación con el precio en 2022, se comprueba que ha duplicado prácticamente el precio máximo de 2010. Al hecho de que se trata de un distrito céntrico y turístico, en pleno casco histórico de la ciudad de Valencia, el valor sigue siendo extraño. Si se compara con otros barrios del distrito donde la evolución ha sido más estable (por ejemplo Russafa de 2106€/m2 a 2738€/m2 o La Gran Via de 2106€/m2 a 3237€/m2). Se puede argumentar al aumento con los años del turismo y el auge de las casas de alquiler vacacional, la gentrificación o el aumento de los nómadas digitales. 

```{r}
# Histograma de todas las variables numéricas (Corregir año, no debe ser numérico)
fotocasa_compra %>% 
  select(where(is.numeric)) %>%
  gather(key = "Variable", value = "Valor") %>%
  ggplot(aes(x = Valor, fill = Variable)) +
  geom_histogram(bins = 30, alpha = 0.7) +
  facet_wrap(~ Variable, scales = "free") +
  labs(title = "Distribución de Variables Numéricas") +
  theme_minimal()
```
Viendo estos resultados, se presencia las mismas observaciones que nos deja el análisis del diagrama de caja. Los precios de 2010 siguen una distribución más uniforme en un rango más cerrado entre los 1162€/m2 y los 2455€/m2. Por otro lado, los precios de 2022 se dispersan más, con un rango de 1103€/m2 a 4029€/m2, reafirmando una vez más la evolución a la alza de los precios. No obstante, cabe mencionar la similitud entre los histogramas de máximos históricos y precios de 2022. Esto indica que los precios máximos de 2022 se han disparado y apuntalando a ser los máximos históricos alcanzados a la misma vez.

Tras este análisis, se procede a realizar un análisis de correlación entre las variables numéricas para ver si existe alguna relación entre ellas. Para ellos se dispone de la matriz de correlación.

## Análisis univariable (por distrito)

Uno de los aspectos más relevantes comparativamente es agrupar los precios por distrito y ver cómo ha evolucionado el precio por metro cuadrado en cada uno de ellos. Se realiza gráfico de barras para ver la evolución de los precios en los años 2010 y 2022.

```{r}
# Análisis de correlación entre variables numéricas
numeric_data_fotocasa <- fotocasa_compra %>% select(where(is.numeric))
correlation_matrix <- cor(numeric_data_fotocasa, use = "complete.obs")
corrplot(correlation_matrix, method = "color", type = "upper", tl.cex = 0.7,
         title = "Matriz de Correlación")
```
A la vista de los resultados de la matriz, se renueva la idea de que los precios de 2022 y los máximos históricos guardan relación, al ver que el índice de correlación es prácticamente de 1. Esto indica que los precios máximos de 2022 son los máximos históricos y que en comparativa con el 2010, el precio por metro cuadrado ha aumentado considerablemente como promedio entre todos los distritos de la ciudad de Valencia.


```{r}
# Gráfico de barras de la media de precios por metro cuadrado en los años 2010 y 2022 por distrito, rotar etiquetas y ordenar de mayor a menor
fotocasa_compra %>% 
  group_by(DISTRITO) %>% 
  summarise(M2_2010 = mean(M2_2010), M2_2022 = mean(M2_2022)) %>% 
  gather(key = "Año", value = "Precio_m2", M2_2010, M2_2022) %>% 
  ggplot(aes(x = reorder(DISTRITO, Precio_m2), y = Precio_m2, fill = Año)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Precio medio por metro cuadrado en 2010 y 2022 por distrito", x = "Distrito", y = "Precio por metro cuadrado") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
#Contar número de medias que han sido superadas en 2022
fotocasa_compra %>% 
  group_by(DISTRITO) %>% 
  summarise(M2_2010 = mean(M2_2010), M2_2022 = mean(M2_2022)) %>% 
  filter(M2_2022 > M2_2010) %>% 
  nrow()
```
Aunque la tendencia del precio ha sido de aumentar, al cotejar los distintos distritos observamos que en la mayoría de los casos no han sido así. En un total de 12 distritos de los 19, el precio medio por metro cuadrado en 2022 ha superado al de 2010. 


```{r}
#Gráfica de barras del porcentaje de aumento o disminución de la media de precio por metro cuadrado entre 2010 y 2022 para cada distrito
fotocasa_compra %>% 
  group_by(DISTRITO) %>% 
  summarise(M2_2010 = mean(M2_2010), M2_2022 = mean(M2_2022)) %>% 
  mutate(Porcentaje = ((M2_2022 - M2_2010) / M2_2010) * 100) %>% 
  ggplot(aes(x = reorder(DISTRITO, Porcentaje), y = Porcentaje, fill = Porcentaje > 0)) +
  geom_bar(stat = "identity") +
  labs(title = "Porcentaje de aumento o disminución de la media de precio por metro cuadrado entre 2010 y 2022 por distrito", x = "Distrito", y = "Porcentaje") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("red", "green"), labels = c("Disminución", "Aumento"))

```
Los distritos que han experimentado un mayor aumento de precio son los distritos de Ciutat Vella, L'Eixample y El Pla del Real. Por otro lado, los distritos de Poblats del Sud, Benimaclet y Rascanya han experimentado un descenso en el precio medio por metro cuadrado en 2022 respecto a 2010. Esto indica que la evolución de los precios no ha sido uniforme en la ciudad de Valencia. Se puede justificar estas diferencias a la localización de los distritos, la presencia de servicios, la calidad de vida, la gentrificación o la presencia de turismo. Por ejemplo, los tres primeros distritos pertenecen a la zona centro de la ciudad y al casco antiguo en el caso de las dos primeras. Por otro lado, los tres últimos distritos pertenecen a la periferia de la ciudad y son distritos más residenciales, más lejos de los servicios y de la zona turística.

```{r}
#Diagrama de dispersion
fotocasa_compra %>% 
  ggplot(aes(x = M2_2010, y = M2_2022, color = DISTRITO)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  labs(title = "Comparativa de precios por metro cuadrado en 2010 y 2022", x = "Precio por metro cuadrado en 2010", y = "Precio por metro cuadrado en 2022") +
  theme_minimal()
```






# Conclusion

This section is not mandatory, but can be added to the manuscript if the
discussion is unusually long or complex.
